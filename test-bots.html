<!DOCTYPE html>
<html>
<head>
    <title>Bot Automated Testing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .pass {
            background: #1a3a1a;
            border-color: #4caf50;
        }
        .fail {
            background: #3a1a1a;
            border-color: #f44336;
        }
        .loading {
            background: #3a3a1a;
            border-color: #ffc107;
        }
        button {
            background: #4caf50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        .summary {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        h1 { color: #4caf50; }
        h2 { color: #ffc107; }
    </style>
</head>
<body>
    <h1>ü§ñ Automated Bot Testing</h1>
    
    <div class="summary">
        <h2>Test Results Summary</h2>
        <div id="summary">
            <p>Click "Run All Tests" to start</p>
        </div>
    </div>

    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="testIndividualBots()">Test Individual Bots</button>
    <button onclick="clearResults()">Clear Results</button>

    <div id="results"></div>

    <script>
        const API_BASE = 'https://creatorflow-iota.vercel.app';
        let token = '';

        // Get token from localStorage (you'll need to be logged in)
        function getToken() {
            // Try to get from current window
            if (window.localStorage) {
                token = localStorage.getItem('token') || '';
            }
            if (!token) {
                prompt('Enter your auth token (get from browser localStorage):');
            }
            return token;
        }

        async function testBot(botName, endpoint, platform = 'instagram') {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result loading';
            resultDiv.id = `test-${botName}`;
            resultDiv.innerHTML = `<strong>${botName}</strong>: Testing...`;
            document.getElementById('results').appendChild(resultDiv);

            try {
                const startTime = Date.now();
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(`${API_BASE}/api/bots/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({ platform }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const duration = Date.now() - startTime;

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                
                // Check if response has expected structure
                const hasData = data.analysis || data.recommendations || data.success;
                const isValid = hasData && response.status === 200;

                resultDiv.className = `test-result ${isValid ? 'pass' : 'fail'}`;
                resultDiv.innerHTML = `
                    <strong>${botName}</strong>: ${isValid ? '‚úÖ PASS' : '‚ùå FAIL'}
                    <br>Status: ${response.status} | Time: ${duration}ms
                    <br>Has Data: ${hasData ? 'Yes' : 'No'}
                    ${data.tier ? `<br>User Tier: ${data.tier}` : ''}
                `;

                return { name: botName, pass: isValid, duration, status: response.status };
            } catch (error) {
                resultDiv.className = 'test-result fail';
                resultDiv.innerHTML = `
                    <strong>${botName}</strong>: ‚ùå FAIL
                    <br>Error: ${error.message}
                    ${error.name === 'AbortError' ? '<br>‚è±Ô∏è Request timed out' : ''}
                `;
                return { name: botName, pass: false, error: error.message };
            }
        }

        async function runAllTests() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').innerHTML = '<p>Running tests...</p>';

            if (!getToken()) {
                alert('Please log in first, then get your token from browser console:\nlocalStorage.getItem("token")');
                return;
            }

            const bots = [
                { name: 'Content Assistant', endpoint: 'content-assistant', needsContent: true },
                { name: 'Scheduling Assistant', endpoint: 'scheduling-assistant' },
                { name: 'Engagement Analyzer', endpoint: 'engagement-analyzer' },
                { name: 'Trend Scout', endpoint: 'trend-scout' },
                { name: 'Content Curation', endpoint: 'content-curation' },
                { name: 'Analytics Coach', endpoint: 'analytics-coach' }
            ];

            const results = [];

            for (const bot of bots) {
                if (bot.needsContent) {
                    // Content Assistant needs content parameter
                    const result = await testContentAssistant();
                    results.push(result);
                } else {
                    const result = await testBot(bot.name, bot.endpoint);
                    results.push(result);
                }
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
            }

            // Summary
            const passed = results.filter(r => r.pass).length;
            const failed = results.filter(r => !r.pass).length;
            const avgTime = results.reduce((sum, r) => sum + (r.duration || 0), 0) / results.length;

            document.getElementById('summary').innerHTML = `
                <h3>Test Summary</h3>
                <p><strong>Total Tests:</strong> ${results.length}</p>
                <p style="color: #4caf50;"><strong>Passed:</strong> ${passed}</p>
                <p style="color: ${failed > 0 ? '#f44336' : '#4caf50'}"><strong>Failed:</strong> ${failed}</p>
                <p><strong>Average Response Time:</strong> ${Math.round(avgTime)}ms</p>
                <p><strong>Success Rate:</strong> ${Math.round((passed / results.length) * 100)}%</p>
            `;
        }

        async function testContentAssistant() {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result loading';
            resultDiv.id = 'test-content-assistant';
            resultDiv.innerHTML = '<strong>Content Assistant</strong>: Testing...';
            document.getElementById('results').appendChild(resultDiv);

            try {
                const startTime = Date.now();
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(`${API_BASE}/api/bots/content-assistant`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        content: 'Test content for automated testing',
                        platform: 'instagram',
                        hashtags: '#test #automation'
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const duration = Date.now() - startTime;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const hasData = data.analysis && data.analysis.score !== undefined;

                resultDiv.className = `test-result ${hasData ? 'pass' : 'fail'}`;
                resultDiv.innerHTML = `
                    <strong>Content Assistant</strong>: ${hasData ? '‚úÖ PASS' : '‚ùå FAIL'}
                    <br>Status: ${response.status} | Time: ${duration}ms
                    <br>Score: ${hasData ? data.analysis.score : 'N/A'}
                    <br>Has Suggestions: ${hasData && data.analysis.suggestions ? 'Yes' : 'No'}
                `;

                return { name: 'Content Assistant', pass: hasData, duration, status: response.status };
            } catch (error) {
                resultDiv.className = 'test-result fail';
                resultDiv.innerHTML = `
                    <strong>Content Assistant</strong>: ‚ùå FAIL
                    <br>Error: ${error.message}
                `;
                return { name: 'Content Assistant', pass: false, error: error.message };
            }
        }

        async function testIndividualBots() {
            const botName = prompt('Which bot to test?\n1. Content Assistant\n2. Scheduling Assistant\n3. Engagement Analyzer\n4. Trend Scout\n5. Content Curation\n6. Analytics Coach');
            const botMap = {
                '1': { name: 'Content Assistant', endpoint: 'content-assistant', needsContent: true },
                '2': { name: 'Scheduling Assistant', endpoint: 'scheduling-assistant' },
                '3': { name: 'Engagement Analyzer', endpoint: 'engagement-analyzer' },
                '4': { name: 'Trend Scout', endpoint: 'trend-scout' },
                '5': { name: 'Content Curation', endpoint: 'content-curation' },
                '6': { name: 'Analytics Coach', endpoint: 'analytics-coach' }
            };

            const bot = botMap[botName];
            if (!bot) {
                alert('Invalid selection');
                return;
            }

            if (bot.needsContent) {
                await testContentAssistant();
            } else {
                await testBot(bot.name, bot.endpoint);
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').innerHTML = '<p>Click "Run All Tests" to start</p>';
        }

        // Auto-run if token is available
        window.onload = function() {
            if (getToken()) {
                console.log('Token found! Ready to test.');
            } else {
                console.log('No token found. Please log in first.');
            }
        };
    </script>
</body>
</html>

